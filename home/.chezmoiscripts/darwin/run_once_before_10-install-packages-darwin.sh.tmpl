#!/bin/bash
{{ if (eq .chezmoi.os "darwin") -}}

# Close App Store apps in case this script updates them
# killall Amphetamine iMovie OneDrive "The Unarchiver" Xcode XMind

# Disable quarantine for casks
export HOMEBREW_CASK_OPTS=--no-quarantine

# Determine install profile. Prefer env override, fallback to chezmoi data, default to "personal".
export DOTFILES_PROFILE=${DOTFILES_PROFILE:-"{{ or .profile "personal" }}"}

# Render the templated Brewfile and install from it
TMP_BREWFILE="$(mktemp -t Brewfile.XXXXXX)"
trap 'rm -f "$TMP_BREWFILE"' EXIT
chezmoi execute-template < {{ .chezmoi.sourceDir }}/Brewfile > "$TMP_BREWFILE"
cat "$TMP_BREWFILE"
brew bundle --file="$TMP_BREWFILE"

{{ end -}}
